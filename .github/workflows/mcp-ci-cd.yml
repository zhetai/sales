name: MCP CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      instruction:
        description: 'è‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼Œå¦‚"è¿è¡Œå•å…ƒæµ‹è¯•å¹¶éªŒè¯è¦†ç›–ç‡â‰¥80%"'
        required: true
        type: string
      timeout:
        description: 'è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'
        required: false
        type: number
        default: 10

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.9'

jobs:
  mcp-ci-cd:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [22]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
        
      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
        
      - name: å®‰è£…ä¾èµ–
        run: |
          # è®¾ç½®æ›´é•¿çš„è¶…æ—¶æ—¶é—´
          npm config set fetch-timeout 300000
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000
          
          # å°è¯•å®‰è£…ä¾èµ–ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨ç¼“å­˜
          npm install --force --no-audit --no-fund --timeout=300000 || {
            echo "âš ï¸ npm install è¶…æ—¶ï¼Œå°è¯•ä½¿ç”¨ç°æœ‰ä¾èµ–"
            if [ -d "node_modules" ]; then
              echo "âœ… ä½¿ç”¨ç°æœ‰çš„ node_modules"
            else
              echo "âŒ æ²¡æœ‰å¯ç”¨çš„ä¾èµ–ï¼Œå®‰è£…å¤±è´¥"
              exit 1
            fi
          }
          
          pip install -r requirements.txt
          
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p ci-cd/{logs,reports}
          
      - name: è¿è¡ŒMCPä»£ç†
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
          REPORT_WEBHOOK_URL: ${{ secrets.REPORT_WEBHOOK_URL }}
          MCP_AUTH_TOKEN: ${{ secrets.MCP_AUTH_TOKEN }}
        run: |
          # è®¾ç½®æŒ‡ä»¤ï¼ˆæ¥è‡ªworkflow_dispatchæˆ–é»˜è®¤æŒ‡ä»¤ï¼‰
          INSTRUCTION="${{ github.event.inputs.instruction || 'è¿è¡Œå•å…ƒæµ‹è¯•å¹¶éªŒè¯è¦†ç›–ç‡â‰¥80%' }}"
          TIMEOUT="${{ github.event.inputs.timeout || 10 }}"
          
          echo "ğŸ¤– å¯åŠ¨MCP CI/CDä»£ç†"
          echo "ğŸ“ æŒ‡ä»¤: $INSTRUCTION"
          echo "â±ï¸ è¶…æ—¶: ${TIMEOUT}åˆ†é’Ÿ"
          
          # æ£€æŸ¥Pythonç¯å¢ƒ
          python3 --version || {
            echo "âŒ Python3 æœªå®‰è£…"
            exit 1
          }
          
          # æ£€æŸ¥MCPä»£ç†æ–‡ä»¶
          if [ ! -f "ci-cd/mcp_agent.py" ]; then
            echo "âŒ MCPä»£ç†æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # å®‰è£…Pythonä¾èµ–
          pip install -r requirements.txt || {
            echo "âŒ Pythonä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
          }
          
          # æ‰§è¡ŒMCPä»£ç†
          timeout ${TIMEOUT}m python3 ci-cd/mcp_agent.py --instruction="$INSTRUCTION" || {
            echo "âŒ MCPä»£ç†æ‰§è¡Œå¤±è´¥æˆ–è¶…æ—¶"
            exit 1
          }
          
      - name: æ”¶é›†æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“Š æ”¶é›†æ‰§è¡ŒæŠ¥å‘Š..."
          
          # æŸ¥æ‰¾æœ€æ–°çš„æŠ¥å‘Šæ–‡ä»¶
          REPORT_FILE=$(find ci-cd/reports -name "*.json" -type f -printf "%T@%p\n" | sort -r | head -1 | cut -d'@' -f2)
          
          if [ -n "$REPORT_FILE" ]; then
            echo "ğŸ“‹ æœ€æ–°æŠ¥å‘Š: $REPORT_FILE"
            
            # è¾“å‡ºæŠ¥å‘Šæ‘˜è¦
            python3 -c "
import json
with open('$REPORT_FILE', 'r') as f:
    report = json.load(f)
    
print('## ğŸ“Š æ‰§è¡Œæ‘˜è¦')
print(f'- ä¼šè¯ID: {report[\"session_id\"]}')
print(f'- æŒ‡ä»¤: {report[\"instruction\"]}')
print(f'- æ€»ä»»åŠ¡: {report[\"summary\"][\"total\"]}')
print(f'- æˆåŠŸ: {report[\"summary\"].get(\"success\", 0)}')
print(f'- å¤±è´¥: {report[\"summary\"].get(\"failure\", 0)}')
status = \"âœ… æˆåŠŸ\" if report[\"summary\"].get(\"failure\", 0) == 0 else \"âŒ å¤±è´¥\"
print(f'- çŠ¶æ€: {status}')
            "

          else
            echo "âš ï¸ æœªæ‰¾åˆ°æŠ¥å‘Šæ–‡ä»¶"
          fi
          
      - name: ä¸Šä¼ æŠ¥å‘Šäº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-reports
          path: ci-cd/reports/
          retention-days: 30
          
      - name: é€šçŸ¥ç»“æœ
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_PAT }}
        run: |
          # è·å–æœ€æ–°æŠ¥å‘Š
          REPORT_FILE=$(find ci-cd/reports -name "*.json" -type f -printf "%T@%p\n" | sort -r | head -1 | cut -d'@' -f2)
          
          if [ -n "$REPORT_FILE" ]; then
            # æå–æŠ¥å‘Šä¿¡æ¯
            STATUS=$(python3 -c "
import json
with open('$REPORT_FILE', 'r') as f:
    report = json.load(f)
status = 'failure' if report['summary'].get('failure', 0) > 0 else 'success'
print(status)
            ")
            
            # åœ¨PRä¸­åˆ›å»ºè¯„è®ºï¼ˆå¦‚æœæ˜¯PRè§¦å‘ï¼‰
            if [ "$GITHUB_EVENT" = "pull_request" ]; then
              COMMENT_BODY="## ğŸ¤– MCP CI/CD ä»£ç†æ‰§è¡ŒæŠ¥å‘Š

**æŒ‡ä»¤**: ${{ github.event.inputs.instruction || 'è¿è¡Œå•å…ƒæµ‹è¯•å¹¶éªŒè¯è¦†ç›–ç‡â‰¥80%' }}
**çŠ¶æ€**: $([ "$STATUS" = "success" ] && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥")

$(python3 -c "
import json
with open('$REPORT_FILE', 'r') as f:
    report = json.load(f)
    
print('### ğŸ“Š æ‰§è¡Œç»“æœ')
print(f'- æ€»ä»»åŠ¡æ•°: {report[\"summary\"][\"total\"]}')
print(f'- æˆåŠŸ: {report[\"summary\"][\"success\"]}')
print(f'- å¤±è´¥: {report[\"summary\"][\"failure\"]}')
    
if report.get('recommendations'):
    print('### ğŸ’¡ å»ºè®®')
    for rec in report['recommendations']:
        print(f'- {rec}')
")
              
              gh pr comment ${{ github.event.number }} --body "$COMMENT_BODY"
            fi
            
            # åˆ›å»ºIssueï¼ˆå¦‚æœæœ‰å¤±è´¥ï¼‰
            if [ "$STATUS" = "failure" ]; then
              ISSUE_TITLE="ğŸš¨ MCP CI/CDä»£ç†æ‰§è¡Œå¤±è´¥"
              ISSUE_BODY="## MCP CI/CDä»£ç†æ‰§è¡ŒæŠ¥å‘Š

**ä¼šè¯ID**: $(python3 -c "import json; report=json.load(open('$REPORT_FILE')); print(report['session_id'])")
**æŒ‡ä»¤**: ${{ github.event.inputs.instruction }}
**æ—¶é—´**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

### ğŸ“Š æ‰§è¡Œæ‘˜è¦
$(python3 -c "
import json
with open('$REPORT_FILE', 'r') as f:
    report = json.load(f)
print(f'- æ€»ä»»åŠ¡æ•°: {report[\"summary\"][\"total\"]}')
print(f'- æˆåŠŸ: {report[\"summary\"][\"success\"]}')
print(f'- å¤±è´¥: {report[\"summary\"][\"failure\"]}')
")

### ğŸ”§ å¤±è´¥è¯¦æƒ…
$(python3 -c "
import json
with open('$REPORT_FILE', 'r') as f:
    report = json.load(f)
for result in report['results']:
    if result['status'] == 'failure':
        print(f'- {result[\"action\"]}: {result.get(\"error\", \"æœªçŸ¥é”™è¯¯\")}')
")
              
              gh issue create --title "$ISSUE_TITLE" --body "$ISSUE_BODY" --label "ci/cd" --label "mcp-agent"
            fi
          fi
        else
          echo "âœ… æ‰€æœ‰ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
        fi
        
  # è¶…æ—¶æ§åˆ¶
  timeout-minutes: 15
  time-out-minutes: 15