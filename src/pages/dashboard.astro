---
import Layout from '../layouts/Layout.astro';
import { setSafeInnerHTML, setSafeInnerHTMLFragment } from '../lib/utils.js';
---

<Layout>
  <div id="dashboard">
    <header>
      <h1>è¯å“ä»£é”€è¿è¥ä»ªè¡¨ç›˜</h1>
      <div class="user-info">
        <span>æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button id="logout-btn">é€€å‡º</button>
      </div>
    </header>

    <main>
      <!-- ç­›é€‰å™¨åŒºåŸŸ -->
      <section class="filters">
        <div class="filter-group">
          <label for="time-range">æ—¶é—´èŒƒå›´:</label>
          <select id="time-range">
            <option value="è¿‘7å¤©">è¿‘7å¤©</option>
            <option value="è¿‘30å¤©">è¿‘30å¤©</option>
            <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="platform">å¹³å°:</label>
          <select id="platform">
            <option value="æŠ–éŸ³">æŠ–éŸ³</option>
            <option value="è§†é¢‘å·">è§†é¢‘å·</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="product-type">å•†å“ç±»å‹:</label>
          <select id="product-type">
            <option value="ä¿å¥å“">ä¿å¥å“</option>
            <option value="åŒ»ç–—å™¨æ¢°">åŒ»ç–—å™¨æ¢°</option>
            <option value="å¤„æ–¹è¯">å¤„æ–¹è¯</option>
          </select>
        </div>
        <button id="refresh-btn">åˆ·æ–°æ•°æ®</button>
      </section>

      <!-- æŒ‡æ ‡å¡ç‰‡åŒºåŸŸ -->
      <section class="metrics">
        <h2>å…³é”®æŒ‡æ ‡</h2>
        <div class="metrics-grid" id="metrics-container">
          <!-- æŒ‡æ ‡å¡ç‰‡å°†é€šè¿‡APIåŠ¨æ€åŠ è½½ -->
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </section>

      <!-- å›¾è¡¨åŒºåŸŸ -->
      <section class="charts">
        <h2>æ•°æ®å¯è§†åŒ–</h2>
        <div class="charts-grid" id="charts-container">
          <!-- å›¾è¡¨å°†é€šè¿‡APIåŠ¨æ€åŠ è½½ -->
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </section>

      <!-- æ™ºèƒ½é€‰å“ -->
      <section class="selection-strategy">
        <h2>æ™ºèƒ½é€‰å“</h2>
        <div class="selection-grid" id="selection-container">
          <!-- é€‰å“ç­–ç•¥å°†é€šè¿‡APIåŠ¨æ€åŠ è½½ -->
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </section>

      <!-- æƒé™æ§åˆ¶åŒºåŸŸ -->
      <section class="permissions">
        <h2>æƒé™ç®¡ç†</h2>
        <div class="permissions-grid" id="permissions-container">
          <!-- æƒé™é¢æ¿å°†é€šè¿‡APIåŠ¨æ€åŠ è½½ -->
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </section>

      <!-- é¢„è­¦ç³»ç»Ÿ -->
      <section class="alerts">
        <h2>ç³»ç»Ÿé¢„è­¦</h2>
        <div class="alerts-grid" id="alerts-container">
          <!-- é¢„è­¦ä¿¡æ¯å°†é€šè¿‡APIåŠ¨æ€åŠ è½½ -->
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </section>
    </main>
  </div>
</Layout>

<script>
  // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', async () => {
    // åˆå§‹åŒ–é¡µé¢æ•°æ®
    await initializeDashboard();
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    bindEventListeners();
  });

  // åˆå§‹åŒ–ä»ªè¡¨ç›˜
  const initializeDashboard = async () => {
    try {
      // å¹¶è¡ŒåŠ è½½æ‰€æœ‰ä»ªè¡¨ç›˜æ•°æ®
      const loadDataPromises = [
        loadMetrics().catch(error => {
          console.error('åŠ è½½æŒ‡æ ‡æ•°æ®å¤±è´¥:', error);
          showError('æŒ‡æ ‡æ•°æ®åŠ è½½å¤±è´¥');
        }),
        loadCharts().catch(error => {
          console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
          showError('å›¾è¡¨æ•°æ®åŠ è½½å¤±è´¥');
        }),
        loadPermissions().catch(error => {
          console.error('åŠ è½½æƒé™æ•°æ®å¤±è´¥:', error);
          showError('æƒé™æ•°æ®åŠ è½½å¤±è´¥');
        }),
        loadSelectionStrategy().catch(error => {
          console.error('åŠ è½½é€‰å“ç­–ç•¥å¤±è´¥:', error);
          showError('é€‰å“ç­–ç•¥åŠ è½½å¤±è´¥');
        }),
        loadAlerts().catch(error => {
          console.error('åŠ è½½é¢„è­¦ä¿¡æ¯å¤±è´¥:', error);
          showError('é¢„è­¦ä¿¡æ¯åŠ è½½å¤±è´¥');
        })
      ];
      
      // ç­‰å¾…æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ
      await Promise.all(loadDataPromises);
    } catch (error) {
      console.error('åˆå§‹åŒ–ä»ªè¡¨ç›˜å¤±è´¥:', error);
      showError('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  };

  // åŠ è½½æµé‡è¿è¥æŒ‡æ ‡æ•°æ®
  const loadMetrics = async () => {
    const container = document.getElementById('metrics-container');
    const platform = document.getElementById('platform').value;
    const productType = document.getElementById('product-type').value;
    
    try {
      // æ¸…ç©ºå®¹å™¨
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      
      // åˆ›å»ºæµé‡è¿è¥æ¨¡å—çš„æŒ‡æ ‡å¡ç‰‡
      const trafficModules = [
        {
          id: 'chanmama-ad',
          title: 'åƒå·æŠ•æ”¾',
          description: 'ROIåŸºå‡†çº¿ç®¡æ§',
          icon: 'ğŸ“ˆ',
          color: '#007BFF'
        },
        {
          id: 'jietiao-clipping',
          title: 'æ™ºèƒ½å‰ªè¾‘',
          description: 'WASMå¤šç‰ˆæœ¬å¤„ç†',
          icon: 'âœ‚ï¸',
          color: '#28A745'
        },
        {
          id: 'influencer-rec',
          title: 'è¾¾äººæ¨è',
          description: 'å¸¦è´§æ¡ä»¶åŒ¹é…',
          icon: 'ğŸ‘¥',
          color: '#FFC107'
        },
        {
          id: 'publish-schedule',
          title: 'å‘å¸ƒè°ƒåº¦',
          description: 'å¾®ä¿¡é€šçŸ¥',
          icon: 'â°',
          color: '#DC3545'
        }
      ];
      
      // æ¸²æŸ“æµé‡è¿è¥æ¨¡å—å¡ç‰‡
      renderTrafficModules(trafficModules);
      
      // ä¸ºæ¯ä¸ªæ¨¡å—åŠ è½½è¯¦ç»†æ•°æ®
      loadTrafficModuleData();
    } catch (error) {
      console.error('åŠ è½½æµé‡è¿è¥æŒ‡æ ‡æ•°æ®å¤±è´¥:', error);
      // Clear existing content
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      // Add error element
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = 'æµé‡è¿è¥æŒ‡æ ‡æ•°æ®åŠ è½½å¤±è´¥';
      container.appendChild(errorDiv);
    }
  };

  // æ¸²æŸ“æµé‡è¿è¥æ¨¡å—å¡ç‰‡
  const renderTrafficModules = (modules) => {
    const container = document.getElementById('metrics-container');
    
    if (!modules || modules.length === 0) {
      // Clear existing content
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      // Add empty element
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'empty';
      emptyDiv.textContent = 'æš‚æ— æµé‡è¿è¥æ¨¡å—æ•°æ®';
      container.appendChild(emptyDiv);
      return;
    }
    
    // Clear existing content
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
    // Create and append module elements
    modules.map(module => {
      const moduleDiv = document.createElement('div');
      moduleDiv.className = 'metric-card traffic-module-card';
      moduleDiv.dataset.module = module.id;
      setSafeInnerHTMLFragment(moduleDiv, `
        <div class="metric-header">
          <h3 class="metric-name">${module.icon} ${module.title}</h3>
        </div>
        <div class="metric-value">
          <span class="value" style="color: ${module.color}">${module.description}</span>
        </div>
        <div class="metric-trend">
          <div class="module-status loading">åŠ è½½ä¸­...</div>
          <div class="module-details" style="display: none;"></div>
        </div>
      `);
      container.appendChild(moduleDiv);
    });
  };

  // å¸¦è¶…æ—¶çš„fetchå‡½æ•°
  const fetchWithTimeout = async (url, options, timeout = 10000) => {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      return response;
    } catch (error) {
      clearTimeout(timeoutId);
      throw error;
    }
  };

  // åŠ è½½æµé‡è¿è¥æ¨¡å—è¯¦ç»†æ•°æ®
  const loadTrafficModuleData = async () => {
    const platform = document.getElementById('platform').value;
    
    // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ¨¡å—æ•°æ®
    const promises = [
      // åŠ è½½åƒå·æŠ•æ”¾æ•°æ®
      fetchWithTimeout('/api/chanmama_ad_placement', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          product_id: "ç¤ºä¾‹äº§å“-12345",
          budget: 10000,
          target_audience: "ç†¬å¤œå…š/é…’å±€å…š",
          platform: platform
        })
      }, 10000).then(response => {
        if (response.ok) {
          return response.json().then(adData => {
            const adCard = document.querySelector('.traffic-module-card[data-module="chanmama-ad"]');
            if (adCard) {
              const statusDiv = adCard.querySelector('.module-status');
              const detailsDiv = adCard.querySelector('.module-details');
              
              statusDiv.style.display = 'none';
              detailsDiv.style.display = 'block';
              setSafeInnerHTMLFragment(detailsDiv, `
                <div class="detail-item">
                  <span class="detail-label">é¢„æµ‹ROI:</span>
                  <span class="detail-value">${adData.roi_prediction}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">é¢„ç®—åˆ†é…:</span>
                  <span class="detail-value">æµ‹è¯•${adData.budget_allocation.test}/æ­£å¼${adData.budget_allocation.formal}</span>
                </div>
              `);
            }
          });
        }
      }).catch(error => {
        console.error('åŠ è½½åƒå·æŠ•æ”¾æ•°æ®å¤±è´¥:', error);
        const adCard = document.querySelector('.traffic-module-card[data-module="chanmama-ad"]');
        if (adCard) {
          const statusDiv = adCard.querySelector('.module-status');
          statusDiv.textContent = 'åŠ è½½å¤±è´¥';
          statusDiv.className = 'module-status error';
        }
      }),
      
      // åŠ è½½æ™ºèƒ½å‰ªè¾‘æ•°æ®
      fetchWithTimeout('/api/jietiao_smart_clipping', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          video_url: "https://oss.aliyuncs.com/raw_video.mp4",
          product_type: document.getElementById('product-type').value,
          target_duration: 30
        })
      }, 10000).then(response => {
        if (response.ok) {
          return response.json().then(clipData => {
            const clipCard = document.querySelector('.traffic-module-card[data-module="jietiao-clipping"]');
            if (clipCard) {
              const statusDiv = clipCard.querySelector('.module-status');
              const detailsDiv = clipCard.querySelector('.module-details');
              
              statusDiv.style.display = 'none';
              detailsDiv.style.display = 'block';
              setSafeInnerHTMLFragment(detailsDiv, `
                <div class="detail-item">
                  <span class="detail-label">å¤„ç†çŠ¶æ€:</span>
                  <span class="detail-value">${clipData.wasm_status ? 'æˆåŠŸ' : 'å¤±è´¥'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">é«˜å®Œæ’­ç‡:</span>
                  <span class="detail-value">${clipData.processed_videos.length}ä¸ªç‰ˆæœ¬</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">WASMç•Œé¢:</span>
                  <span class="detail-value">å‰ªæ˜ ã€Œæ™ºèƒ½æˆç‰‡ã€ç”Ÿæˆ10ä¸ªä¸åŒç‰ˆæœ¬è§†é¢‘ï¼Œç­›é€‰å®Œæ’­ç‡ï¼35%çš„ç´ æ</span>
                </div>
              `);
            }
          });
        }
      }).catch(error => {
        console.error('åŠ è½½æ™ºèƒ½å‰ªè¾‘æ•°æ®å¤±è´¥:', error);
        const clipCard = document.querySelector('.traffic-module-card[data-module="jietiao-clipping"]');
        if (clipCard) {
          const statusDiv = clipCard.querySelector('.module-status');
          statusDiv.textContent = 'åŠ è½½å¤±è´¥';
          statusDiv.className = 'module-status error';
        }
      }),
      
      // åŠ è½½è¾¾äººæ¨èæ•°æ®
      fetchWithTimeout('/api/influencer_recommendation', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          product_type: document.getElementById('product-type').value,
          target_platform: platform,
          budget_range: "ä¸­ï¼ˆ5000-2ä¸‡ï¼‰"
        })
      }, 10000).then(response => {
        if (response.ok) {
          return response.json().then(influencerData => {
            const influencerCard = document.querySelector('.traffic-module-card[data-module="influencer-rec"]');
            if (influencerCard) {
              const statusDiv = influencerCard.querySelector('.module-status');
              const detailsDiv = influencerCard.querySelector('.module-details');
              
              statusDiv.style.display = 'none';
              detailsDiv.style.display = 'block';
              
              // æ„å»ºè¾¾äººä¿¡æ¯HTML
              let influencersHTML = '';
              if (influencerData.influencers && influencerData.influencers.length > 0) {
                influencersHTML = influencerData.influencers.map(influencer => `
                  <div class="detail-item">
                    <span class="detail-label">è¾¾äºº:</span>
                    <span class="detail-value">
                      <a href="${influencer.profile_url || '#'}" target="_blank" style="color: #007BFF; text-decoration: underline;">
                        ${influencer.name}
                      </a>
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">ç²‰ä¸æ•°:</span>
                    <span class="detail-value">${influencer.follower_count}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">è½¬åŒ–ç‡:</span>
                    <span class="detail-value">${influencer.conversion_rate}</span>
                  </div>
                `).join('');
              }
              
              setSafeInnerHTMLFragment(detailsDiv, `
                <div class="detail-item">
                  <span class="detail-label">æ¨èè¾¾äºº:</span>
                  <span class="detail-value">${influencerData.influencers.length}ä½</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">æœ€é«˜è½¬åŒ–:</span>
                  <span class="detail-value">${influencerData.influencers[0]?.conversion_rate || 'N/A'}</span>
                </div>
                ${influencersHTML}
              `);
            }
          });
        }
      }).catch(error => {
        console.error('åŠ è½½è¾¾äººæ¨èæ•°æ®å¤±è´¥:', error);
        const influencerCard = document.querySelector('.traffic-module-card[data-module="influencer-rec"]');
        if (influencerCard) {
          const statusDiv = influencerCard.querySelector('.module-status');
          statusDiv.textContent = 'åŠ è½½å¤±è´¥';
          statusDiv.className = 'module-status error';
        }
      }),
      
      // åŠ è½½å‘å¸ƒè°ƒåº¦æ•°æ®
      fetchWithTimeout('/api/publish_schedule_webhook', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          platform: platform,
          publish_time: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // æ˜å¤©åŒä¸€æ—¶é—´
          main_account_id: "main_account_123",
          sub_account_ids: ["sub_account_456", "sub_account_789"],
          webhook_url: "https://sc.ftqq.com/your_server_chan_key.send"
        })
      }, 10000).then(response => {
        if (response.ok) {
          return response.json().then(publishData => {
            const publishCard = document.querySelector('.traffic-module-card[data-module="publish-schedule"]');
            if (publishCard) {
              const statusDiv = publishCard.querySelector('.module-status');
              const detailsDiv = publishCard.querySelector('.module-details');
              
              statusDiv.style.display = 'none';
              detailsDiv.style.display = 'block';
              setSafeInnerHTMLFragment(detailsDiv, `
                <div class="detail-item">
                  <span class="detail-label">å‘å¸ƒçŠ¶æ€:</span>
                  <span class="detail-value">${publishData.publish_status}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">é€šçŸ¥çŠ¶æ€:</span>
                  <span class="detail-value">${publishData.webhook_status}</span>
                </div>
              `);
            }
          });
        }
      }).catch(error => {
        console.error('åŠ è½½å‘å¸ƒè°ƒåº¦æ•°æ®å¤±è´¥:', error);
        const publishCard = document.querySelector('.traffic-module-card[data-module="publish-schedule"]');
        if (publishCard) {
          const statusDiv = publishCard.querySelector('.module-status');
          statusDiv.textContent = 'åŠ è½½å¤±è´¥';
          statusDiv.className = 'module-status error';
        }
      })
    ];
    
    // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
    await Promise.allSettled(promises);
  };

  // åŠ è½½å›¾è¡¨æ•°æ®
  const loadCharts = async () => {
    const container = document.getElementById('charts-container');
    
    try {
      const response = await fetch('/api/dashboard_config_generator', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          chart_list: [
            { metric: 'æ’­æ”¾é‡', chart_type: 'line', title: 'æ’­æ”¾é‡è¶‹åŠ¿' },
            { metric: 'è½¬åŒ–ç‡', chart_type: 'bar', title: 'è½¬åŒ–ç‡å¯¹æ¯”' },
            { metric: 'æµé‡å æ¯”', chart_type: 'pie', title: 'å¹³å°æµé‡åˆ†å¸ƒ' }
          ],
          time_range: document.getElementById('time-range').value,
          platform: document.getElementById('platform').value
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      // æ¸²æŸ“å›¾è¡¨
      renderCharts(data.config_json.charts);
    } catch (error) {
      console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
      // Clear existing content
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      // Add error element
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = 'å›¾è¡¨æ•°æ®åŠ è½½å¤±è´¥';
      container.appendChild(errorDiv);
    }
  };

  // æ¸²æŸ“å›¾è¡¨
  const renderCharts = (charts) => {
    const container = document.getElementById('charts-container');
    
    if (!charts || charts.length === 0) {
      // Clear existing content
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      // Add empty element
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'empty';
      emptyDiv.textContent = 'æš‚æ— å›¾è¡¨æ•°æ®';
      container.appendChild(emptyDiv);
      return;
    }
    
    // Clear existing content
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
    // Create and append chart elements
    charts.map(chart => {
      // ä¸ºæ¯ä¸ªå›¾è¡¨ç”Ÿæˆå”¯ä¸€çš„ID
      const chartId = `chart-${chart.id}`;
      
      const chartDiv = document.createElement('div');
      chartDiv.className = 'chart-card';
      chartDiv.dataset.chartId = chart.id;
      setSafeInnerHTMLFragment(chartDiv, `
        <div class="chart-header">
          <h3 class="chart-title">${chart.options.title}</h3>
        </div>
        <div class="chart-container">
          <canvas id="${chartId}"></canvas>
        </div>
      `);
      container.appendChild(chartDiv);
    });
    
    // æ¸²æŸ“æ¯ä¸ªå›¾è¡¨
    charts.forEach(chart => {
      const chartId = `chart-${chart.id}`;
      const canvas = document.getElementById(chartId);
      
      if (canvas) {
        // åŠ¨æ€å¯¼å…¥Chart.js
        import('https://cdn.jsdelivr.net/npm/chart.js').then(({ Chart, registerables }) => {
          Chart.register(...registerables);
          
          // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨å®ä¾‹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          if (canvas.chart) {
            canvas.chart.destroy();
          }
          
          // æ ¹æ®å›¾è¡¨ç±»å‹åˆ›å»ºä¸åŒçš„å›¾è¡¨
          if (chart.type === 'line') {
            canvas.chart = new Chart(canvas, {
              type: 'line',
              data: {
                labels: chart.data.xAxis,
                datasets: [{
                  label: chart.options.yAxisName || chart.options.title,
                  data: chart.data.series[0].data,
                  borderColor: '#007BFF',
                  backgroundColor: 'rgba(0, 123, 255, 0.1)',
                  tension: 0.4,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: chart.options.title
                  },
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              }
            });
          } else if (chart.type === 'bar') {
            canvas.chart = new Chart(canvas, {
              type: 'bar',
              data: {
                labels: chart.data.xAxis,
                datasets: [{
                  label: chart.options.yAxisName || chart.options.title,
                  data: chart.data.series[0].data,
                  backgroundColor: '#28A745',
                  borderColor: '#218838',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: chart.options.title
                  },
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              }
            });
          } else if (chart.type === 'pie') {
            canvas.chart = new Chart(canvas, {
              type: 'pie',
              data: {
                labels: chart.data.categories,
                datasets: [{
                  data: chart.data.series[0].data,
                  backgroundColor: [
                    '#007BFF',
                    '#28A745',
                    '#FFC107',
                    '#DC3545',
                    '#6F42C1'
                  ],
                  borderColor: '#fff',
                  borderWidth: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: chart.options.title
                  },
                  legend: {
                    position: 'bottom'
                  }
                }
              }
            });
          }
        }).catch(error => {
          console.error('åŠ è½½Chart.jså¤±è´¥:', error);
          // å¦‚æœChart.jsåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦
          const chartContainer = canvas.parentElement;
          setSafeInnerHTMLFragment(chartContainer, `
            <div class="chart-placeholder">
              <p>å›¾è¡¨åŠ è½½å¤±è´¥</p>
              <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p>
            </div>
          `);
        });
      }
    });
  };

  // åŠ è½½æƒé™æ•°æ®
  const loadPermissions = async () => {
    const container = document.getElementById('permissions-container');
    
    // æ¨¡æ‹Ÿæƒé™æ•°æ®
    const permissions = {
      roles: ["å“ç‰Œæ–¹", "ä»£é”€æ–¹", "å®¢æœ"],
      permissions: {
        "å“ç‰Œæ–¹": ["æŸ¥çœ‹é”€å”®æ•°æ®", "æŸ¥çœ‹ROI", "ç¼–è¾‘åˆä½œæ¡æ¬¾", "å¯¼å‡ºæŠ¥å‘Š"],
        "ä»£é”€æ–¹": ["æŸ¥çœ‹é”€å”®æ•°æ®", "æŸ¥çœ‹åº“å­˜", "æäº¤é€€è´§ç”³è¯·", "æŸ¥çœ‹é¢„è­¦"],
        "å®¢æœ": ["æŸ¥çœ‹é€€è´§ç”³è¯·", "æ›´æ–°å”®åçŠ¶æ€", "æŸ¥çœ‹é¢„è­¦"]
      }
    };
    
    // æ¸²æŸ“æƒé™é¢æ¿
    renderPermissions(permissions);
  };

  // åŠ è½½é€‰å“ç­–ç•¥
  const loadSelectionStrategy = async () => {
    const container = document.getElementById('selection-container');
    
    try {
      // è·å–é€‰å“ç­–ç•¥æ•°æ®
      const response = await fetch('/api/drug-selection-strategy');
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      // æ¸²æŸ“é€‰å“ç­–ç•¥
      renderSelectionStrategy(data);
    } catch (error) {
      console.error('åŠ è½½é€‰å“ç­–ç•¥å¤±è´¥:', error);
      // Clear existing content
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      // Add error element
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = 'é€‰å“ç­–ç•¥åŠ è½½å¤±è´¥';
      container.appendChild(errorDiv);
    }
  };

  // æ¸²æŸ“é€‰å“ç­–ç•¥
  const renderSelectionStrategy = (strategy) => {
    const container = document.getElementById('selection-container');
    
    if (!strategy) {
      // Clear existing content
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      // Add empty element
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'empty';
      emptyDiv.textContent = 'æš‚æ— é€‰å“ç­–ç•¥æ•°æ®';
      container.appendChild(emptyDiv);
      return;
    }
    
    // åˆ›å»ºé€‰å“ç­–ç•¥å¡ç‰‡
    const strategyCards = [
      {
        title: 'èˆ†æƒ…ç›‘æ§',
        description: strategy.config.public_opinion_monitoring.purpose,
        details: `
          <div class="detail-item">
            <span class="detail-label">ç›‘æ§å·¥å…·:</span>
            <span class="detail-value">${strategy.config.public_opinion_monitoring.tool}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">è¿‡æ»¤è§„åˆ™:</span>
            <span class="detail-value">${strategy.config.public_opinion_monitoring.filter_rule}</span>
          </div>
        `,
        icon: 'ğŸ”'
      },
      {
        title: 'çƒ­ç‚¹å€ŸåŠ¿',
        description: strategy.config.hot_product_selection.hot_trend_borrowing.selection_logic,
        details: `
          <div class="detail-item">
            <span class="detail-label">è¿½è¸ªå¹³å°:</span>
            <span class="detail-value">${strategy.config.hot_product_selection.hot_trend_borrowing.platform}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">è¿½è¸ªæ¦œå•:</span>
            <span class="detail-value">${strategy.config.hot_product_selection.hot_trend_borrowing.tracked_list}</span>
          </div>
        `,
        icon: 'ğŸ”¥'
      },
      {
        title: 'æ•°æ®éªŒè¯',
        description: 'éªŒè¯è½¬åŒ–ç‡ã€é€€è´§ç‡ã€å¤è´­ç‡ç­‰å…³é”®æŒ‡æ ‡',
        details: `
          <div class="detail-item">
            <span class="detail-label">éªŒè¯å·¥å…·:</span>
            <span class="detail-value">${strategy.config.hot_product_selection.data_verification.tool}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">è½¬åŒ–ç‡é˜ˆå€¼:</span>
            <span class="detail-value">${strategy.config.hot_product_selection.data_verification.metrics[0].threshold}</span>
          </div>
        `,
        icon: 'ğŸ“Š'
      },
      {
        title: 'åˆ©æ¶¦æµ‹ç®—',
        description: strategy.config.hot_product_selection.profit_calculation.profit_target,
        details: `
          <div class="detail-item">
            <span class="detail-label">ä½£é‡‘èŒƒå›´:</span>
            <span class="detail-value">${strategy.config.hot_product_selection.profit_calculation.commission_range}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ROIåŸºå‡†çº¿:</span>
            <span class="detail-value">${strategy.config.hot_product_selection.profit_calculation.cost_coverage.platform_ad_cost}</span>
          </div>
        `,
        icon: 'ğŸ’°'
      }
    ];
    
    // Clear existing content
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
    // Create and append strategy elements
    const strategyGrid = document.createElement('div');
    strategyGrid.className = 'strategy-grid';
    strategyCards.map(card => {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'strategy-card';
      setSafeInnerHTMLFragment(cardDiv, `
        <div class="strategy-header">
          <h3 class="strategy-title">${card.icon} ${card.title}</h3>
        </div>
        <div class="strategy-description">
          <p>${card.description}</p>
        </div>
        <div class="strategy-details">
          ${card.details}
        </div>
      `);
      strategyGrid.appendChild(cardDiv);
    });
    container.appendChild(strategyGrid);
    
    // æ·»åŠ é€‰å“äº§å“éƒ¨åˆ†
    const productsDiv = document.createElement('div');
    productsDiv.className = 'selected-products';
    setSafeInnerHTMLFragment(productsDiv, `
      <h3>æ¨èé€‰å“</h3>
      <div class="products-grid">
        ${strategy.example_output.selected_products.map(product => `
          <div class="product-card">
            <h4>${product.product_name}</h4>
            <div class="product-detail">
              <span class="detail-label">èˆ†æƒ…è¯„åˆ†:</span>
              <span class="detail-value">${product.èˆ†æƒ…è¯„åˆ†}</span>
            </div>
            <div class="product-detail">
              <span class="detail-label">æ•°æ®è¡¨ç°:</span>
              <span class="detail-value">${product.æ•°æ®è¡¨ç°}</span>
            </div>
            <div class="product-detail">
              <span class="detail-label">åˆ©æ¶¦ç©ºé—´:</span>
              <span class="detail-value">${product.åˆ©æ¶¦ç©ºé—´}</span>
            </div>
          </div>
        `).join('')}
      </div>
    `);
    container.appendChild(productsDiv);
  };

  // æ¸²æŸ“æƒé™é¢æ¿
  const renderPermissions = (permissions) => {
    const container = document.getElementById('permissions-container');
    
    if (!permissions || !permissions.roles) {
      // Clear existing content
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      // Add empty element
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'empty';
      emptyDiv.textContent = 'æš‚æ— æƒé™æ•°æ®';
      container.appendChild(emptyDiv);
      return;
    }
    
    // Clear existing content
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
    // Create and append permissions elements
    const permissionsPanel = document.createElement('div');
    permissionsPanel.className = 'permissions-panel';
    
    const rolesList = document.createElement('div');
    rolesList.className = 'roles-list';
    const rolesHeader = document.createElement('h3');
    rolesHeader.textContent = 'è§’è‰²åˆ—è¡¨';
    rolesList.appendChild(rolesHeader);
    const rolesUl = document.createElement('ul');
    permissions.roles.map(role => {
      const roleLi = document.createElement('li');
      roleLi.textContent = role;
      rolesUl.appendChild(roleLi);
    });
    rolesList.appendChild(rolesUl);
    permissionsPanel.appendChild(rolesList);
    
    const permissionsDetails = document.createElement('div');
    permissionsDetails.className = 'permissions-details';
    const permissionsHeader = document.createElement('h3');
    permissionsHeader.textContent = 'æƒé™è¯¦æƒ…';
    permissionsDetails.appendChild(permissionsHeader);
    permissions.roles.map(role => {
      const rolePermissions = document.createElement('div');
      rolePermissions.className = 'role-permissions';
      const roleHeader = document.createElement('h4');
      roleHeader.textContent = role;
      rolePermissions.appendChild(roleHeader);
      const permissionsUl = document.createElement('ul');
      permissions.permissions[role].map(permission => {
        const permissionLi = document.createElement('li');
        permissionLi.textContent = permission;
        permissionsUl.appendChild(permissionLi);
      });
      rolePermissions.appendChild(permissionsUl);
      permissionsDetails.appendChild(rolePermissions);
    });
    permissionsPanel.appendChild(permissionsDetails);
    
    container.appendChild(permissionsPanel);
  };

  // åŠ è½½é¢„è­¦ä¿¡æ¯
  const loadAlerts = async () => {
    const container = document.getElementById('alerts-container');
    
    // æ¨¡æ‹Ÿé¢„è­¦æ•°æ®
    const alerts = [
      { status: 'normal', message: 'ç³»ç»Ÿè¿è¡Œæ­£å¸¸', action: 'æŸ¥çœ‹è¯¦æƒ…' },
      { status: 'warning', message: 'è½¬åŒ–ç‡ç•¥æœ‰ä¸‹é™', action: 'æŸ¥çœ‹è¯¦æƒ…' },
      { status: 'error', message: 'é€€è´§ç‡å¼‚å¸¸å¢é«˜', action: 'ç«‹å³å¤„ç†' }
    ];
    
    // æ¸²æŸ“é¢„è­¦ä¿¡æ¯
    renderAlerts(alerts);
  };

  // æ¸²æŸ“é¢„è­¦ä¿¡æ¯
  const renderAlerts = (alerts) => {
    const container = document.getElementById('alerts-container');
    
    if (!alerts || alerts.length === 0) {
      // Clear existing content
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      // Add empty element
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'empty';
      emptyDiv.textContent = 'æš‚æ— é¢„è­¦ä¿¡æ¯';
      container.appendChild(emptyDiv);
      return;
    }
    
    // Clear existing content
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
    // Create and append alert elements
    alerts.map(alert => {
      // æ ¹æ®çŠ¶æ€è·å–é¢œè‰²
      const getStatusColor = (status) => {
        switch (status) {
          case 'error': return '#DC3545';
          case 'warning': return '#FFC107';
          default: return '#28A745';
        }
      };
      
      // æ ¹æ®çŠ¶æ€è·å–æ–‡æœ¬
      const getStatusText = (status) => {
        switch (status) {
          case 'error': return 'å¼‚å¸¸';
          case 'warning': return 'é¢„è­¦';
          default: return 'æ­£å¸¸';
        }
      };
      
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert-indicator';
      alertDiv.dataset.status = alert.status;
      setSafeInnerHTMLFragment(alertDiv, `
        <div class="status-light" style="background-color: ${getStatusColor(alert.status)}"></div>
        <div class="alert-content">
          <span class="status-text">${getStatusText(alert.status)}</span>
          <span class="alert-message">${alert.message}</span>
        </div>
        <button class="alert-action" data-status="${alert.status}">${alert.action}</button>
      `);
      container.appendChild(alertDiv);
    });
    
    // ä¸ºé¢„è­¦æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.querySelectorAll('.alert-action').forEach(button => {
      button.addEventListener('click', (event) => {
        const status = event.target.dataset.status;
        showAlertDetails(status);
      });
    });
  };

  // æ˜¾ç¤ºä¸‹é’»è¯¦æƒ…
  const showDrillDownDetails = (metricName) => {
    // æ ¹æ®æŒ‡æ ‡åç§°æ˜¾ç¤ºä¸åŒçš„è¯¦æƒ…ä¿¡æ¯
    let details = '';
    switch (metricName) {
      case 'æ’­æ”¾é‡':
        details = `æ’­æ”¾é‡è¯¦æƒ…ï¼š
- ä»Šæ—¥æ’­æ”¾é‡ï¼š120,000æ¬¡
- æ˜¨æ—¥æ’­æ”¾é‡ï¼š105,000æ¬¡
- ç¯æ¯”å¢é•¿ï¼šâ†‘15%
- çƒ­é—¨å•†å“ï¼šå•†å“A(30,000æ¬¡)ã€å•†å“B(25,000æ¬¡)ã€å•†å“C(20,000æ¬¡)`;
        break;
      case 'è½¬åŒ–ç‡':
        details = `è½¬åŒ–ç‡è¯¦æƒ…ï¼š
- å½“å‰è½¬åŒ–ç‡ï¼š3.8%
- æ˜¨æ—¥è½¬åŒ–ç‡ï¼š3.8%
- ç¯æ¯”æŒå¹³ï¼šâ†’0%
- é«˜è½¬åŒ–å•†å“ï¼šå•†å“X(5.2%)ã€å•†å“Y(4.8%)ã€å•†å“Z(4.1%)`;
        break;
      case 'é€€è´§ç‡':
        details = `é€€è´§ç‡è¯¦æƒ…ï¼š
- å½“å‰é€€è´§ç‡ï¼š4.2%
- æ˜¨æ—¥é€€è´§ç‡ï¼š4.5%
- ç¯æ¯”ä¸‹é™ï¼šâ†“5%
- é«˜é€€è´§å•†å“ï¼šå•†å“M(8.1%)ã€å•†å“N(7.3%)ã€å•†å“O(6.5%)`;
        break;
      case 'å¤è´­ç‡':
        details = `å¤è´­ç‡è¯¦æƒ…ï¼š
- å½“å‰å¤è´­ç‡ï¼š12.3%
- ä¸Šæœˆå¤è´­ç‡ï¼š12.0%
- ç¯æ¯”å¢é•¿ï¼šâ†‘3%
- é«˜å¤è´­ç”¨æˆ·ï¼šç”¨æˆ·ç»„A(25.1%)ã€ç”¨æˆ·ç»„B(18.7%)ã€ç”¨æˆ·ç»„C(15.2%)`;
        break;
      default:
        details = `${metricName}è¯¦æƒ…ï¼š
- æ•°æ®æ­£å¸¸
- æ— å¼‚å¸¸æƒ…å†µ
- å»ºè®®ç»§ç»­ä¿æŒ`;
    }
    
    alert(details);
  };

  // æ˜¾ç¤ºé¢„è­¦è¯¦æƒ…
  const showAlertDetails = (status) => {
    // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„è¯¦æƒ…ä¿¡æ¯
    let details = '';
    switch (status) {
      case 'error':
        details = `ç³»ç»Ÿå¼‚å¸¸è¯¦æƒ…ï¼š
- å¼‚å¸¸æ—¶é—´ï¼š${new Date().toLocaleString()}
- å¼‚å¸¸ç±»å‹ï¼šç³»ç»Ÿé”™è¯¯
- å½±å“èŒƒå›´ï¼šæ ¸å¿ƒæœåŠ¡
- å»ºè®®æªæ–½ï¼šç«‹å³è”ç³»æŠ€æœ¯æ”¯æŒ`;
        break;
      case 'warning':
        details = `ç³»ç»Ÿé¢„è­¦è¯¦æƒ…ï¼š
- é¢„è­¦æ—¶é—´ï¼š${new Date().toLocaleString()}
- é¢„è­¦ç±»å‹ï¼šæ€§èƒ½ä¸‹é™
- å½±å“èŒƒå›´ï¼šéƒ¨åˆ†åŠŸèƒ½
- å»ºè®®æªæ–½ï¼šç›‘æ§ç³»ç»Ÿæ€§èƒ½`;
        break;
      default:
        details = `ç³»ç»ŸçŠ¶æ€è¯¦æƒ…ï¼š
- æ£€æŸ¥æ—¶é—´ï¼š${new Date().toLocaleString()}
- ç³»ç»ŸçŠ¶æ€ï¼šè¿è¡Œæ­£å¸¸
- æ€§èƒ½æŒ‡æ ‡ï¼šæ‰€æœ‰æŒ‡æ ‡æ­£å¸¸
- å»ºè®®æªæ–½ï¼šç»§ç»­ä¿æŒç›‘æ§`;
    }
    
    // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºè¯¦æƒ…
    const modal = document.createElement('div');
    modal.className = 'modal';
    setSafeInnerHTMLFragment(modal, `
      <div class="modal-content">
        <div class="modal-header">
          <h3>è¯¦æƒ…ä¿¡æ¯</h3>
          <span class="close">Ã—</span>
        </div>
        <div class="modal-body">
          <pre>${details}</pre>
        </div>
      </div>
    `);
    
    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
      .modal {
        display: block;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
      }
      
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 0;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      
      .modal-header {
        padding: 15px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 8px 8px 0 0;
      }
      
      .modal-header h3 {
        margin: 0;
        color: #333;
      }
      
      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      
      .close:hover {
        color: #000;
      }
      
      .modal-body {
        padding: 20px;
      }
      
      .modal-body pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: inherit;
        line-height: 1.5;
      }
    `;
    
    document.head.appendChild(style);
    document.body.appendChild(modal);
    
    // æ·»åŠ å…³é—­äº‹ä»¶
    modal.querySelector('.close').addEventListener('click', () => {
      document.body.removeChild(modal);
      document.head.removeChild(style);
    });
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.addEventListener('click', (event) => {
      if (event.target === modal) {
        document.body.removeChild(modal);
        document.head.removeChild(style);
      }
    });
  };

  // é˜²æŠ–å‡½æ•°
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };

  // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
  const bindEventListeners = () => {
    // ä¸ºç­›é€‰å™¨æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
    const debouncedLoad = debounce(async () => {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showLoadingState();
      await initializeDashboard();
    }, 300);
    
    const filters = document.querySelectorAll('.filter-group select');
    filters.forEach(filter => {
      filter.addEventListener('change', debouncedLoad);
    });
    
    // åˆ·æ–°æŒ‰é’®
    document.getElementById('refresh-btn').addEventListener('click', async () => {
      showLoadingState();
      await initializeDashboard();
    });
    
    // é€€å‡ºæŒ‰é’®
    document.getElementById('logout-btn').addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        // è¿™é‡Œåº”è¯¥è°ƒç”¨é€€å‡ºç™»å½•çš„API
        alert('å·²é€€å‡ºç™»å½•');
        // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
        // window.location.href = '/login';
      }
    });
  };

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  const showLoadingState = () => {
    const containers = [
      'metrics-container',
      'charts-container',
      'selection-container',
      'permissions-container',
      'alerts-container'
    ];
    
    containers.forEach(containerId => {
      const container = document.getElementById(containerId);
      if (container) {
        // Clear existing content
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        // Add loading element
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.textContent = 'åŠ è½½ä¸­...';
        container.appendChild(loadingDiv);
      }
    });
  };

  // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    const showError = (message) => {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #f5c6cb;
        z-index: 1000;
      `;
      
      document.body.appendChild(errorDiv);
      
      // 3ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        if (errorDiv.parentElement) {
          errorDiv.remove();
        }
      }, 3000);
    };
</script>

<style>
  #dashboard {
    font-family: Inter, Roboto, 'Helvetica Neue', 'Arial Nova', 'Nimbus Sans', Arial, sans-serif;
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
    flex-wrap: wrap;
    gap: 15px;
  }

  header h1 {
    margin: 0;
    font-size: 24px;
    color: #333;
    flex: 1;
    min-width: 200px;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  #logout-btn {
    padding: 8px 16px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
  }

  #logout-btn:hover {
    background: #c82333;
  }

  /* ç­›é€‰å™¨æ ·å¼ */
  .filters {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    flex-wrap: wrap;
    align-items: end;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 150px;
  }

  .filter-group label {
    font-weight: 500;
    white-space: nowrap;
  }

  .filter-group select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    min-width: 120px;
    flex: 1;
  }

  #refresh-btn {
    padding: 8px 16px;
    background: #007BFF;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    align-self: flex-end;
    height: fit-content;
  }

  #refresh-btn:hover {
    background: #0069d9;
  }

  /* æŒ‡æ ‡å¡ç‰‡æ ·å¼ */
  .metrics h2, .charts h2, .permissions h2, .alerts h2 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
  }

  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .metric-card {
    padding: 20px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
  }

  .metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  .metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .metric-name {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }

  .drill-down-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    color: #007BFF;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .drill-down-btn:hover {
    background: #f0f8ff;
  }

  .metric-value {
    margin-bottom: 15px;
    flex: 1;
  }

  .value {
    font-size: 24px;
    font-weight: 700;
    color: #007BFF;
  }

  .unit {
    margin-left: 5px;
    font-size: 14px;
    color: #666;
  }

  .metric-trend {
    font-size: 14px;
    font-weight: 500;
  }

  /* æµé‡è¿è¥æ¨¡å—ä¸“ç”¨æ ·å¼ */
  .traffic-module-card {
    text-align: center;
  }

  .traffic-module-card .metric-name {
    font-size: 18px;
    margin-bottom: 10px;
  }

  .traffic-module-card .value {
    font-size: 16px;
    font-weight: normal;
    color: #666;
  }

  .module-status {
    font-size: 14px;
    color: #666;
  }

  .module-status.loading {
    color: #007BFF;
  }

  .module-details {
    text-align: left;
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 14px;
  }

  .detail-label {
    color: #666;
  }

  .detail-value {
    color: #333;
    font-weight: 500;
  }

  /* å›¾è¡¨æ ·å¼ */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .chart-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
  }

  .chart-header {
    margin-bottom: 15px;
  }

  .chart-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .chart-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 4px;
    min-height: 300px;
    position: relative;
  }

  .chart-placeholder {
    text-align: center;
    color: #666;
    padding: 20px;
  }

  .chart-placeholder h4 {
    margin-top: 0;
  }

  .chart-placeholder p {
    margin: 5px 0;
  }

  /* Canvas æ ·å¼ */
  .chart-container canvas {
    max-width: 100%;
    max-height: 100%;
  }

  /* æƒé™é¢æ¿æ ·å¼ */
  .permissions-grid {
    margin-bottom: 30px;
  }

  .permissions-panel {
    display: flex;
    flex-direction: row;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    gap: 20px;
  }

  .roles-list {
    flex: 1;
  }

  .permissions-details {
    flex: 2;
  }

  .roles-list h3, .permissions-details h3 {
    margin-top: 0;
  }

  .roles-list ul, .role-permissions ul {
    list-style-type: none;
    padding: 0;
  }

  .roles-list li, .role-permissions li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }

  .role-permissions {
    margin-bottom: 20px;
  }

  .role-permissions h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #007BFF;
  }

  /* æ™ºèƒ½é€‰å“æ ·å¼ */
  .selection-grid {
    margin-bottom: 30px;
  }

  .strategy-grid {
    display: flex;
    flex-direction: row;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }

  .strategy-card {
    flex: 1;
    min-width: 250px;
    padding: 20px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .strategy-header {
    margin-bottom: 15px;
  }

  .strategy-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .strategy-description p {
    margin: 0 0 15px 0;
    color: #666;
    font-size: 14px;
  }

  .strategy-details .detail-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 13px;
  }

  .strategy-details .detail-label {
    color: #666;
  }

  .strategy-details .detail-value {
    color: #333;
    font-weight: 500;
    text-align: right;
  }

  .selected-products h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
  }

  .products-grid {
    display: flex;
    flex-direction: row;
    gap: 20px;
    flex-wrap: wrap;
  }

  .product-card {
    flex: 1;
    min-width: 300px;
    padding: 15px;
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
  }

  .product-card h4 {
    margin: 0 0 10px 0;
    font-size: 16px;
    color: #333;
  }

  .product-detail {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 13px;
  }

  .product-detail .detail-label {
    color: #666;
  }

  .product-detail .detail-value {
    color: #333;
    font-weight: 500;
    text-align: right;
  }

  /* é¢„è­¦ç³»ç»Ÿæ ·å¼ */
  .alerts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
  }

  .alert-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .status-light {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .alert-content {
    flex: 1;
    min-width: 0;
  }

  .status-text {
    font-weight: 600;
    margin-right: 10px;
  }

  .alert-message {
    font-size: 14px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .alert-action {
    padding: 6px 12px;
    background: #007BFF;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
  }

  .alert-action:hover {
    background: #0069d9;
  }

  /* åŠ è½½å’Œé”™è¯¯çŠ¶æ€æ ·å¼ */
  .loading, .empty, .error {
    text-align: center;
    padding: 40px 20px;
    color: #666;
  }

  .error {
    color: #dc3545;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 1200px) {
    #dashboard {
      padding: 15px;
    }
    
    .metrics-grid {
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
    
    .charts-grid {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
  }

  @media (max-width: 992px) {
    header {
      flex-direction: column;
      gap: 15px;
      text-align: center;
    }
    
    .user-info {
      width: 100%;
      justify-content: center;
    }
    
    .filters {
      flex-direction: row;
      flex-wrap: wrap;
    }
    
    .filter-group {
      flex: 1;
      min-width: 150px;
    }
    
    .permissions-panel {
      flex-direction: column;
    }
    
    .charts-grid {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
  }

  @media (max-width: 768px) {
    #dashboard {
      padding: 10px;
    }
    
    header h1 {
      font-size: 20px;
    }
    
    .filters {
      flex-direction: column;
      align-items: stretch;
      padding: 15px;
    }
    
    .filter-group {
      justify-content: space-between;
      width: 100%;
      margin-bottom: 10px;
    }
    
    .filter-group select {
      flex: 1;
      min-width: unset;
    }
    
    #refresh-btn {
      align-self: center;
      width: 100%;
    }
    
    .metrics-grid, .charts-grid, .alerts-grid {
      grid-template-columns: 1fr;
    }
    
    .metrics-grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    
    .permissions-panel {
      flex-direction: column;
      padding: 15px;
    }
    
    .chart-container {
      min-height: 150px;
    }
    
    .strategy-grid,
    .products-grid {
      flex-direction: column;
    }
  }

  @media (max-width: 576px) {
    #dashboard {
      padding: 8px;
    }
    
    header {
      margin-bottom: 20px;
      padding-bottom: 15px;
    }
    
    header h1 {
      font-size: 18px;
    }
    
    .filter-group {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .filter-group label {
      margin-bottom: 5px;
    }
    
    .metrics-grid {
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .metric-card {
      padding: 15px;
    }
    
    .value {
      font-size: 20px;
    }
    
    .charts-grid {
      gap: 15px;
    }
    
    .chart-card {
      padding: 15px;
    }
    
    .alerts-grid {
      gap: 15px;
    }
    
    .alert-indicator {
      padding: 8px 12px;
    }
    
    .strategy-card,
    .product-card {
      min-width: 100%;
    }
  }

  /* è¶…å°å±å¹•ä¼˜åŒ– */
  @media (max-width: 400px) {
    #dashboard {
      padding: 5px;
    }
    
    header h1 {
      font-size: 16px;
    }
    
    .filter-group select {
      padding: 6px 10px;
      font-size: 14px;
    }
    
    #refresh-btn, #logout-btn {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .metric-name {
      font-size: 14px;
    }
    
    .value {
      font-size: 18px;
    }
    
    .chart-title {
      font-size: 16px;
    }
    
    .strategy-card,
    .product-card {
      min-width: 100%;
    }
  }
</style>