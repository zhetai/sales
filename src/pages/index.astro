---
import Layout from '../layouts/Layout.astro';
import '../lib/api.js';
---

<Layout>
  <div id="dashboard">
    <header>
      <h1>药品代销运营仪表盘</h1>
      <div class="user-info">
        <span>欢迎，管理员</span>
        <button id="logout-btn">退出</button>
      </div>
    </header>

    <main>
      <!-- 筛选器区域 -->
      <section class="filters">
        <div class="filter-group">
          <label for="time-range">时间范围:</label>
          <select id="time-range">
            <option value="近7天">近7天</option>
            <option value="近30天" selected>近30天</option>
            <option value="自定义">自定义</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="platform">平台:</label>
          <select id="platform">
            <option value="全部" selected>全部</option>
            <option value="抖音">抖音</option>
            <option value="视频号">视频号</option>
            <option value="其他">其他</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="product-type">商品类型:</label>
          <select id="product-type">
            <option value="全部" selected>全部</option>
            <option value="保健品">保健品</option>
            <option value="医疗器械">医疗器械</option>
            <option value="处方药">处方药</option>
          </select>
        </div>
        <button id="refresh-btn">刷新数据</button>
      </section>

      <!-- 指标卡片区域 -->
      <section class="metrics">
        <h2>关键指标</h2>
        <div class="metrics-grid" id="metrics-container">
          <!-- 指标卡片将通过API动态加载 -->
          <div class="loading">加载中...</div>
        </div>
      </section>

      <!-- 图表区域 -->
      <section class="charts">
        <h2>数据可视化</h2>
        <div class="charts-grid" id="charts-container">
          <!-- 图表将通过API动态加载 -->
          <div class="loading">加载中...</div>
        </div>
      </section>

      <!-- 警报区域 -->
      <section class="alerts">
        <h2>运营警报</h2>
        <div class="alerts-list" id="alerts-container">
          <!-- 警报将通过API动态加载 -->
          <div class="loading">加载中...</div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // 页面加载完成后初始化数据
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化指标数据
      initializeMetrics();
      
      // 初始化图表
      initializeCharts();
      
      // 初始化警报
      initializeAlerts();
      
      // 绑定事件监听器
      bindEventListeners();
    });

    // 初始化指标数据
    async function initializeMetrics() {
      try {
        const response = await fetch('/api/operation_indicator_query', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            time_range: document.getElementById('time-range').value,
            platform: document.getElementById('platform').value,
            product_type: document.getElementById('product-type').value,
            metric_types: ['播放量', '转化率', 'ROI', '退货率', '客单价', '复购率']
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          renderMetrics(data.indicators);
        } else {
          console.error('Failed to fetch metrics:', response.status);
          document.getElementById('metrics-container').innerHTML = '<div class="error">加载失败，请稍后重试</div>';
        }
      } catch (error) {
        console.error('Error fetching metrics:', error);
        document.getElementById('metrics-container').innerHTML = '<div class="error">网络错误，请检查连接</div>';
      }
    }

    // 初始化图表
    async function initializeCharts() {
      try {
        const response = await fetch('/api/dashboard_config_generator', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            chart_list: [
              { metric: '播放量', chart_type: 'line', title: '播放量趋势' },
              { metric: '转化率', chart_type: 'bar', title: '转化率对比' },
              { metric: 'ROI', chart_type: 'line', title: 'ROI趋势' }
            ],
            time_range: document.getElementById('time-range').value,
            platform: document.getElementById('platform').value
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          renderCharts(data.config_json.charts);
        } else {
          console.error('Failed to fetch charts:', response.status);
          document.getElementById('charts-container').innerHTML = '<div class="error">加载失败，请稍后重试</div>';
        }
      } catch (error) {
        console.error('Error fetching charts:', error);
        document.getElementById('charts-container').innerHTML = '<div class="error">网络错误，请检查连接</div>';
      }
    }

    // 初始化警报
    async function initializeAlerts() {
      try {
        // 这里应该调用实际的API获取警报数据
        // 暂时使用模拟数据
        const alerts = [
          { id: 1, level: 'warning', message: '退货率超过阈值5%', time: '2025-10-15 14:30' },
          { id: 2, level: 'info', message: '新合作条款待确认', time: '2025-10-15 10:15' }
        ];
        renderAlerts(alerts);
      } catch (error) {
        console.error('Error fetching alerts:', error);
        document.getElementById('alerts-container').innerHTML = '<div class="error">加载失败，请稍后重试</div>';
      }
    }

    // 渲染指标数据
    function renderMetrics(indicators) {
      const container = document.getElementById('metrics-container');
      
      if (!indicators || indicators.length === 0) {
        container.innerHTML = '<div class="empty">暂无数据</div>';
        return;
      }
      
      container.innerHTML = indicators.map(indicator => `
        <div class="metric-card">
          <h3>${indicator.metric_name}</h3>
          <div class="value">${indicator.value}<span class="unit">${indicator.unit}</span></div>
          <div class="trend ${indicator.trend.includes('↑') ? 'up' : indicator.trend.includes('↓') ? 'down' : 'stable'}">
            ${indicator.trend}
          </div>
        </div>
      `).join('');
    }

    // 渲染图表
    function renderCharts(charts) {
      const container = document.getElementById('charts-container');
      
      if (!charts || charts.length === 0) {
        container.innerHTML = '<div class="empty">暂无数据</div>';
        return;
      }
      
      container.innerHTML = charts.map(chart => `
        <div class="chart-card">
          <h3>${chart.options.title}</h3>
          <div class="chart-placeholder">
            <p>图表类型: ${chart.type}</p>
            <p>数据点: ${chart.data.xAxis ? chart.data.xAxis.length : 'N/A'}</p>
          </div>
        </div>
      `).join('');
    }

    // 渲染警报
    function renderAlerts(alerts) {
      const container = document.getElementById('alerts-container');
      
      if (!alerts || alerts.length === 0) {
        container.innerHTML = '<div class="empty">暂无警报</div>';
        return;
      }
      
      container.innerHTML = alerts.map(alert => `
        <div class="alert-item ${alert.level}">
          <span class="alert-level">${alert.level === 'warning' ? '⚠️' : 'ℹ️'}</span>
          <div class="alert-content">
            <p>${alert.message}</p>
            <span class="alert-time">${alert.time}</span>
          </div>
        </div>
      `).join('');
    }

    // 绑定事件监听器
    function bindEventListeners() {
      // 刷新按钮
      document.getElementById('refresh-btn').addEventListener('click', function() {
        document.getElementById('metrics-container').innerHTML = '<div class="loading">加载中...</div>';
        document.getElementById('charts-container').innerHTML = '<div class="loading">加载中...</div>';
        document.getElementById('alerts-container').innerHTML = '<div class="loading">加载中...</div>';
        initializeMetrics();
        initializeCharts();
        initializeAlerts();
      });
      
      // 筛选器变化
      document.getElementById('time-range').addEventListener('change', handleFilterChange);
      document.getElementById('platform').addEventListener('change', handleFilterChange);
      document.getElementById('product-type').addEventListener('change', handleFilterChange);
    }

    // 处理筛选器变化
    function handleFilterChange() {
      document.getElementById('metrics-container').innerHTML = '<div class="loading">加载中...</div>';
      document.getElementById('charts-container').innerHTML = '<div class="loading">加载中...</div>';
      initializeMetrics();
      initializeCharts();
    }

    // 退出按钮
    document.getElementById('logout-btn').addEventListener('click', function() {
      if (confirm('确定要退出登录吗？')) {
        // 这里应该调用实际的登出API
        alert('已退出登录');
        // 跳转到登录页面
        window.location.href = '/login';
      }
    });
  </script>
</Layout>

<style>
  #dashboard {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
  }

  header h1 {
    margin: 0;
    color: #333;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  #logout-btn {
    padding: 8px 16px;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  #logout-btn:hover {
    background-color: #c82333;
  }

  .filters {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-group label {
    font-weight: 500;
  }

  .filter-group select,
  .filter-group input {
    padding: 6px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
  }

  .filter-group input[type="date"] {
    width: 120px;
  }

  #refresh-btn {
    padding: 8px 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    align-self: flex-end;
  }

  #refresh-btn:hover {
    background-color: #0069d9;
  }

  .metrics {
    margin-bottom: 30px;
  }

  .metrics h2,
  .charts h2,
  .alerts h2 {
    margin-bottom: 20px;
    color: #333;
  }

  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .metric-card {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .metric-card h3 {
    margin: 0 0 10px 0;
    font-size: 16px;
    color: #666;
  }

  .value {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
  }

  .unit {
    font-size: 14px;
    font-weight: normal;
    color: #666;
  }

  .trend {
    font-size: 14px;
  }

  .trend.up {
    color: #28a745;
  }

  .trend.down {
    color: #dc3545;
  }

  .trend.stable {
    color: #6c757d;
  }

  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .chart-card {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .chart-card h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #333;
  }

  .chart-placeholder {
    height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-color: #f8f9fa;
    border-radius: 4px;
  }

  .alerts-list {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .alert-item {
    display: flex;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 4px;
    border-left: 4px solid;
  }

  .alert-item.warning {
    background-color: #fff3cd;
    border-left-color: #ffc107;
  }

  .alert-item.info {
    background-color: #d1ecf1;
    border-left-color: #17a2b8;
  }

  .alert-level {
    font-size: 20px;
    margin-right: 10px;
  }

  .alert-content {
    flex: 1;
  }

  .alert-content p {
    margin: 0 0 5px 0;
  }

  .alert-time {
    font-size: 12px;
    color: #666;
  }

  .loading,
  .empty,
  .error {
    text-align: center;
    padding: 40px 20px;
    color: #666;
  }

  .error {
    color: #dc3545;
  }

  @media (max-width: 768px) {
    .filters {
      flex-direction: column;
    }

    .filter-group {
      width: 100%;
      margin-bottom: 10px;
    }

    .metrics-grid,
    .charts-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
